# Boss Mode Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add autonomous `/boss` mode where Cody works continuously on todos.md tasks or app improvements until ESC is pressed.

**Architecture:** Add `bossMode` flag to runtimeSettings, modify agent loop to skip iteration cap when active, create boss loop in index.ts that injects continuation prompts and listens for ESC.

**Tech Stack:** Node.js readline, raw stdin for keypress detection

---

## Task 1: Add Boss Mode Runtime Settings

**Files:**
- Modify: `src/config.ts:54-62`

**Step 1: Add boss mode flags to runtimeSettings**

```typescript
export const runtimeSettings = {
  // When true, show the model's <think>...</think> reasoning
  showThinking: true,
  // When true, show extra debug logs (API errors, request details, etc.)
  debug: false,
  // When true, agent is in autonomous boss mode
  bossMode: false,
  // Set to true when ESC is pressed to interrupt boss mode
  bossInterrupted: false,
};
```

**Step 2: Verify build**

Run: `pnpm build`
Expected: No errors

**Step 3: Commit**

```bash
git add src/config.ts
git commit -m "feat: add bossMode flags to runtimeSettings"
```

---

## Task 2: Modify Agent Loop to Support Boss Mode

**Files:**
- Modify: `src/agent/loop.ts:148-151` (function signature)
- Modify: `src/agent/loop.ts:170-172` (maxIterations logic)
- Modify: `src/agent/loop.ts:183` (while condition)

**Step 1: Add bossMode parameter to runAgentLoop**

Change the function signature at line 148:

```typescript
export async function runAgentLoop(
  conversation: Conversation,
  userMessage: string,
  options: { bossMode?: boolean } = {}
): Promise<string> {
```

**Step 2: Make maxIterations conditional**

Replace lines 170-172:

```typescript
  // Safety limit - prevents infinite loops if the model keeps calling tools forever
  // In boss mode, we don't cap iterations (the outer boss loop handles continuation)
  let iterationCount = 0;
  const maxIterations = options.bossMode ? Infinity : 10;
```

**Step 3: Verify build**

Run: `pnpm build`
Expected: No errors

**Step 4: Commit**

```bash
git add src/agent/loop.ts
git commit -m "feat: add bossMode option to runAgentLoop to bypass iteration cap"
```

---

## Task 3: Add Boss Mode Constants

**Files:**
- Create: `src/boss.ts`

**Step 1: Create boss.ts with constants and types**

```typescript
/**
 * Boss Mode - Autonomous agent operation
 *
 * When activated, Cody works continuously without prompts,
 * checking todos.md or improving the app until ESC is pressed.
 */

export const BOSS_CONTINUATION_PROMPT = `You are in autonomous boss mode. Decide what to work on next:
- Check todos.md for pending tasks (create it if needed)
- Or think of improvements to make this app more useful/attractive

Pick the most valuable action and execute it. When done, explain what you did.`;

export const ESC_KEY = '\x1b';

export const bossMessages = {
  activated: '[BOSS MODE - Press ESC to exit]\nWorking autonomously on todos.md or app improvements...\n',
  deactivated: '\n[Boss mode ended - returning to normal]\n',
  cycle: (n: number) => `\n[Cycle ${n}]`,
};
```

**Step 2: Verify build**

Run: `pnpm build`
Expected: No errors

**Step 3: Commit**

```bash
git add src/boss.ts
git commit -m "feat: add boss mode constants and messages"
```

---

## Task 4: Implement Boss Mode Loop

**Files:**
- Modify: `src/index.ts`

**Step 1: Add imports at top of file (after line 12)**

```typescript
import { runtimeSettings } from "./config.js";
import { BOSS_CONTINUATION_PROMPT, ESC_KEY, bossMessages } from "./boss.js";
```

Note: `runtimeSettings` is already imported via `config`, but we need it mutable. Update the existing import:

```typescript
import { config, runtimeSettings } from "./config.js";
```

**Step 2: Add startBossMode function before main()**

Add this after the showWelcome function (around line 39):

```typescript
/**
 * Start boss mode - autonomous operation until ESC is pressed.
 */
async function startBossMode(
  conversation: Conversation,
  rl: readline.Interface
): Promise<void> {
  console.log(bossMessages.activated);

  // Enable boss mode
  runtimeSettings.bossMode = true;
  runtimeSettings.bossInterrupted = false;

  // Store original stdin state
  const wasRaw = process.stdin.isRaw;

  // Set up ESC key listener
  if (process.stdin.isTTY) {
    process.stdin.setRawMode(true);
  }
  process.stdin.resume();

  const onKeypress = (key: Buffer) => {
    if (key.toString() === ESC_KEY) {
      runtimeSettings.bossInterrupted = true;
    }
  };
  process.stdin.on('data', onKeypress);

  let cycle = 0;

  try {
    // Initial prompt to kick things off
    let prompt = BOSS_CONTINUATION_PROMPT;

    while (!runtimeSettings.bossInterrupted) {
      cycle++;
      console.log(bossMessages.cycle(cycle));
      console.log("─".repeat(60));

      try {
        const response = await runAgentLoop(conversation, prompt, { bossMode: true });
        const renderedResponse = renderContent(response);
        console.log(`\n◆ ${renderedResponse}\n`);
      } catch (error) {
        console.error("\n[Error]", error instanceof Error ? error.message : error);
        console.log("Continuing to next cycle...\n");
      }

      // Check if interrupted during the cycle
      if (runtimeSettings.bossInterrupted) {
        break;
      }

      // Continue with the standard continuation prompt
      prompt = BOSS_CONTINUATION_PROMPT;
    }
  } finally {
    // Clean up: restore stdin state
    process.stdin.removeListener('data', onKeypress);
    if (process.stdin.isTTY) {
      process.stdin.setRawMode(wasRaw ?? false);
    }

    // Disable boss mode
    runtimeSettings.bossMode = false;
    runtimeSettings.bossInterrupted = false;

    console.log(bossMessages.deactivated);
  }
}
```

**Step 3: Verify build**

Run: `pnpm build`
Expected: No errors

**Step 4: Commit**

```bash
git add src/index.ts
git commit -m "feat: implement startBossMode function with ESC detection"
```

---

## Task 5: Add /boss Command Handler

**Files:**
- Modify: `src/index.ts` (inside main function, command handling section)

**Step 1: Add /boss command handler after /new handler (around line 115)**

```typescript
    // Check for /boss command
    if (input === "/boss") {
      await startBossMode(conversation, rl);
      continue;
    }
```

**Step 2: Update unknown command help text (around line 127)**

Update the available commands list:

```typescript
    // Unknown slash command - show available commands
    if (input.startsWith("/")) {
      console.log(`
Unknown command: ${input}

Available commands:
  /boss           Enter autonomous boss mode (ESC to exit)
  /show-thinking  Toggle display of model reasoning
  /debug          Toggle debug mode for extra logs
  /new            Clear conversation memory and start fresh
  exit            Quit Cody
`);
      continue;
    }
```

**Step 3: Update welcome message (around line 36-38)**

```typescript
  console.log(
    `\nCommands: "/boss" for autonomous mode, "/show-thinking" to toggle reasoning, "/debug" for debug logs, "/new" to clear memory, "exit" to quit\n`
  );
```

**Step 4: Verify build**

Run: `pnpm build`
Expected: No errors

**Step 5: Commit**

```bash
git add src/index.ts
git commit -m "feat: add /boss command handler and update help text"
```

---

## Task 6: Manual Testing

**Step 1: Build and run**

```bash
pnpm dev
```

**Step 2: Test /boss command**

1. Type `/boss` and press Enter
2. Verify you see `[BOSS MODE - Press ESC to exit]`
3. Verify cycles start running
4. Press ESC
5. Verify you see `[Boss mode ended - returning to normal]`
6. Verify normal `> ` prompt returns

**Step 3: Test normal mode still works**

1. Type a normal message
2. Verify response appears
3. Type `exit` to quit

**Step 4: Final commit if any fixes needed**

```bash
git add -A
git commit -m "fix: address boss mode testing feedback"
```

---

## Summary

| Task | Description | Files |
|------|-------------|-------|
| 1 | Add runtime settings flags | config.ts |
| 2 | Modify agent loop for boss mode | loop.ts |
| 3 | Create boss mode constants | boss.ts (new) |
| 4 | Implement boss mode loop | index.ts |
| 5 | Add /boss command handler | index.ts |
| 6 | Manual testing | - |
